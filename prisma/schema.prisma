generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -- Enums --

enum LoadStatus {
  SCHEDULED
  GATE_IN
  QUEUED
  LOADING
  GATE_OUT
  FINISHED
  CANCELLED
  REJECTED
  ON_HOLD
  
  // Mapping to database enum name if needed, but let's stick to standard naming
  @@map("load_status")
}

// -- Models --

model Bay {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String        @unique
  isActive      Boolean       @default(true) @map("is_active")
  
  loadSessions  LoadSession[]

  @@map("bays")
}

model Driver {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverCode  String?  @unique @map("driver_code") // e.g. DRV-0142
  name        String
  phone       String?
  licenseId   String?  @unique @map("license_id")
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  orders      Order[]

  @@map("drivers")
}

model Vehicle {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  licensePlate String   @unique @map("license_plate")
  vehicleType  String?  @map("vehicle_type")
  ownerName    String?  @map("owner_name")
  isActive     Boolean  @default(true) @map("is_active")
  
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  orders       Order[]

  @@map("vehicles")
  @@index([licensePlate], map: "idx_vehicles_plate")
}

model Order {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  spNumber      String    @unique @map("sp_number") // e.g. SP-240503
  
  // Foreign Keys
  vehicleId     String    @map("vehicle_id") @db.Uuid
  driverId      String    @map("driver_id") @db.Uuid
  createdBy     String?   @map("created_by") @db.Uuid
  
  // Details
  product       String    @default("FUEL")
  plannedLiters Decimal   @map("planned_liters") @db.Decimal(12, 2)
  scheduledAt   DateTime  @map("scheduled_at") @db.Timestamptz(6)
  notes         String?
  
  // QR logic
  qrCodeValue   String?   @unique @map("qr_code_value")
  qrExpiresAt   DateTime? @map("qr_expires_at") @db.Timestamptz(6)

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relationships
  vehicle       Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: NoAction)
  driver        Driver        @relation(fields: [driverId], references: [id], onDelete: NoAction)
  loadSessions  LoadSession[]

  @@map("orders")
  @@index([driverId], map: "idx_orders_driver")
  @@index([scheduledAt], map: "idx_orders_scheduled_at")
  @@index([vehicleId], map: "idx_orders_vehicle")
}

model LoadSession {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String     @map("order_id") @db.Uuid
  
  status         LoadStatus @default(SCHEDULED)
  
  // Timestamps for the lifecycle
  gateInAt       DateTime?  @map("gate_in_at") @db.Timestamptz(6)
  queuedAt       DateTime?  @map("queued_at") @db.Timestamptz(6)
  loadingStartAt DateTime?  @map("loading_start_at") @db.Timestamptz(6)
  loadingEndAt   DateTime?  @map("loading_end_at") @db.Timestamptz(6)
  gateOutAt      DateTime?  @map("gate_out_at") @db.Timestamptz(6)
  finishedAt     DateTime?  @map("finished_at") @db.Timestamptz(6)
  
  // Operations
  bayId          String?    @map("bay_id") @db.Uuid
  shiftId        String?    @map("shift_id") @db.Uuid
  actualLiters   Decimal?   @map("actual_liters") @db.Decimal(12, 2)
  
  // Issues
  cancelReason   String?    @map("cancel_reason")
  holdReason     String?    @map("hold_reason")
  rejectReason   String?    @map("reject_reason")

  // Metadata
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime   @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relationships
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  bay            Bay?          @relation(fields: [bayId], references: [id], onDelete: NoAction)
  shift          Shift?        @relation(fields: [shiftId], references: [id], onDelete: NoAction)
  cctvCaptures   CctvCapture[]

  @@map("load_sessions")
  @@index([finishedAt], map: "idx_load_sessions_finished_at")
  @@index([orderId], map: "idx_load_sessions_order")
  @@index([status], map: "idx_load_sessions_status")
}

model Shift {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String        @unique
  startTime    DateTime      @map("start_time") @db.Time(6)
  endTime      DateTime      @map("end_time") @db.Time(6)
  isActive     Boolean       @default(true) @map("is_active")
  
  loadSessions LoadSession[]

  @@map("shifts")
}

model CctvCapture {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  loadSessionId   String      @map("load_session_id") @db.Uuid
  capturedAt      DateTime    @default(now()) @map("captured_at") @db.Timestamptz(6)
  storagePath     String      @map("storage_path")
  licensePlateOcr String?     @map("license_plate_ocr")
  cameraId        String?     @map("camera_id")
  
  loadSession     LoadSession @relation(fields: [loadSessionId], references: [id], onDelete: Cascade)

  @@map("cctv_captures")
  @@index([loadSessionId, capturedAt], map: "idx_cctv_session_time")
}