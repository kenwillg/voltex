generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model bays {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String          @unique
  is_active     Boolean         @default(true)
  load_sessions load_sessions[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model cctv_captures {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  load_session_id   String        @db.Uuid
  captured_at       DateTime      @default(now()) @db.Timestamptz(6)
  storage_path      String
  license_plate_ocr String?
  camera_id         String?
  load_sessions     load_sessions @relation(fields: [load_session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([load_session_id, captured_at], map: "idx_cctv_session_time")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model drivers {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driver_code String?  @unique
  name        String
  phone       String?
  license_id  String?  @unique
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)
  orders      orders[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model load_sessions {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id         String          @db.Uuid
  status           load_status     @default(SCHEDULED)
  gate_in_at       DateTime?       @db.Timestamptz(6)
  queued_at        DateTime?       @db.Timestamptz(6)
  loading_start_at DateTime?       @db.Timestamptz(6)
  loading_end_at   DateTime?       @db.Timestamptz(6)
  gate_out_at      DateTime?       @db.Timestamptz(6)
  finished_at      DateTime?       @db.Timestamptz(6)
  bay_id           String?         @db.Uuid
  shift_id         String?         @db.Uuid
  actual_liters    Decimal?        @db.Decimal(12, 2)
  cancel_reason    String?
  hold_reason      String?
  reject_reason    String?
  created_at       DateTime        @default(now()) @db.Timestamptz(6)
  updated_at       DateTime        @default(now()) @db.Timestamptz(6)
  cctv_captures    cctv_captures[]
  bays             bays?           @relation(fields: [bay_id], references: [id], onDelete: NoAction)
  orders           orders          @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  shifts           shifts?         @relation(fields: [shift_id], references: [id], onDelete: NoAction)

  @@index([finished_at], map: "idx_load_sessions_finished_at")
  @@index([order_id], map: "idx_load_sessions_order")
  @@index([status], map: "idx_load_sessions_status")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model orders {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sp_number      String          @unique
  vehicle_id     String          @db.Uuid
  driver_id      String          @db.Uuid
  product        String          @default("FUEL")
  planned_liters Decimal         @db.Decimal(12, 2)
  scheduled_at   DateTime        @db.Timestamptz(6)
  qr_code_value  String?         @unique
  qr_expires_at  DateTime?       @db.Timestamptz(6)
  notes          String?
  created_by     String?         @db.Uuid
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @default(now()) @db.Timestamptz(6)
  load_sessions  load_sessions[]
  drivers        drivers         @relation(fields: [driver_id], references: [id], onDelete: NoAction)
  vehicles       vehicles        @relation(fields: [vehicle_id], references: [id], onDelete: NoAction)

  @@index([driver_id], map: "idx_orders_driver")
  @@index([scheduled_at], map: "idx_orders_scheduled_at")
  @@index([vehicle_id], map: "idx_orders_vehicle")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model shifts {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String          @unique
  start_time    DateTime        @db.Time(6)
  end_time      DateTime        @db.Time(6)
  is_active     Boolean         @default(true)
  load_sessions load_sessions[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model vehicles {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  license_plate String   @unique
  vehicle_type  String?
  owner_name    String?
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)
  orders        orders[]

  @@index([license_plate], map: "idx_vehicles_plate")
}

enum load_status {
  SCHEDULED
  GATE_IN
  QUEUED
  LOADING
  GATE_OUT
  FINISHED
  CANCELLED
  REJECTED
  ON_HOLD
}
